---
source: compiler-core/src/javascript/tests/bit_strings.rs
expression: "\nfn go(x) {\n  <<x:bit_string, \"Gleam\":utf8>>\n}\n"

---
function go(x) {
  return $bit_string([x, new globalThis.TextEncoder().encode("Gleam")]);
}

function $bit_string(segments) {
  let size = segment => segment instanceof Uint8Array ? segment.byteLength : 1;
  let bytes = segments.reduce((acc, segment) => acc + size(segment), 0);
  let view = new DataView(new ArrayBuffer(bytes));
  let cursor = 0;
  for (let segment of segments) {
    if (segment instanceof Uint8Array) {
      new Uint8Array(view.buffer).set(segment, cursor);
      cursor += segment.byteLength;
    } else {
      view.setInt8(cursor, segment);
      cursor++;
    }
  }
  return new Uint8Array(view.buffer);
}

